<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Question Tracker</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
    .dot { width: 20px; height: 20px; border-radius: 50%; display: inline-block; cursor: pointer; }
    .dot-green { background-color: #28a745; }
    .dot-red { background-color: #dc3545; }
    .dot-yellow { background-color: #ffc107; }
    .dot-gray { background-color: #6c757d; }
    td.notes-cell { min-width: 150px; }
</style>
</head>
<body class="bg-light">

<div class="container py-4">
    <h2 class="mb-4 text-center">ðŸ“š Question Tracker</h2>

    <!-- Selectors -->
    <div class="row mb-3">
        <div class="col-md-4">
            <label class="form-label">Book</label>
            <select id="bookSelect" class="form-select"></select>
        </div>
        <div class="col-md-4">
            <label class="form-label">Chapter</label>
            <select id="chapterSelect" class="form-select"></select>
        </div>
        <div class="col-md-4 d-flex align-items-end">
            <button class="btn btn-primary w-100" id="loadChapter">Load</button>
        </div>
    </div>

    <!-- Bulk Buttons -->
    <div class="mb-3 d-none" id="bulkActions">
        <button class="btn btn-success me-2" id="markAllCorrect">Mark All Correct</button>
        <button class="btn btn-danger me-2" id="markAllWrong">Mark All Wrong</button>
        <button class="btn btn-warning me-2" id="markAllNA">Mark All Not Attempted</button>
        <button class="btn btn-secondary" id="newAttempt">âž• New Attempt</button>
    </div>

    <!-- Table -->
    <div class="table-responsive">
        <table class="table table-bordered" id="questionsTable">
            <thead>
                <tr>
                    <th>Q#</th>
                    <th>Notes</th>
                    <th colspan="7" class="text-center">Last 7 Attempts</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<script>
const GITHUB_USER = "YOUR_USERNAME";
const GITHUB_REPO = "YOUR_REPO";
const GITHUB_FILE = "data.json";
const GITHUB_TOKEN = "YOUR_GITHUB_PAT";
const API_URL = `https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/${GITHUB_FILE}`;

let data = { books: {} };
let currentBook = "";
let currentChapter = "";

// Load data from GitHub
async function loadData() {
    const res = await fetch(API_URL, {
        headers: { Authorization: `token ${GITHUB_TOKEN}` }
    });
    if (!res.ok) return;
    const file = await res.json();
    data = JSON.parse(atob(file.content));
    populateSelectors();
}

// Save data to GitHub
async function saveData() {
    const getRes = await fetch(API_URL, {
        headers: { Authorization: `token ${GITHUB_TOKEN}` }
    });
    const file = await getRes.json();

    await fetch(API_URL, {
        method: "PUT",
        headers: { Authorization: `token ${GITHUB_TOKEN}` },
        body: JSON.stringify({
            message: `Update ${currentBook} - ${currentChapter}`,
            content: btoa(JSON.stringify(data, null, 2)),
            sha: file.sha
        })
    });
}

// Populate dropdowns
function populateSelectors() {
    const bookSelect = document.getElementById("bookSelect");
    bookSelect.innerHTML = "";
    Object.keys(data.books).forEach(book => {
        bookSelect.innerHTML += `<option>${book}</option>`;
    });
    bookSelect.addEventListener("change", () => {
        const chapterSelect = document.getElementById("chapterSelect");
        chapterSelect.innerHTML = "";
        const selectedBook = bookSelect.value;
        Object.keys(data.books[selectedBook] || {}).forEach(chapter => {
            chapterSelect.innerHTML += `<option>${chapter}</option>`;
        });
    });
}

// Load chapter table
function loadChapterTable() {
    const tableBody = document.querySelector("#questionsTable tbody");
    tableBody.innerHTML = "";
    document.getElementById("bulkActions").classList.remove("d-none");

    const chapterData = data.books[currentBook][currentChapter];
    const totalQuestions = chapterData.total_questions;
    for (let i = 1; i <= totalQuestions; i++) {
        if (!chapterData.questions[i]) {
            chapterData.questions[i] = { notes: "", attempts: [] };
        }
        const q = chapterData.questions[i];
        const row = document.createElement("tr");

        // Q#
        const qCell = document.createElement("td");
        qCell.textContent = i;
        row.appendChild(qCell);

        // Notes
        const notesCell = document.createElement("td");
        notesCell.classList.add("notes-cell");
        notesCell.contentEditable = true;
        notesCell.textContent = q.notes;
        notesCell.addEventListener("input", () => {
            q.notes = notesCell.textContent;
            saveData();
        });
        row.appendChild(notesCell);

        // Attempts
        for (let j = 0; j < 7; j++) {
            const status = q.attempts[j] || "no_data";
            const dot = document.createElement("span");
            dot.classList.add("dot");
            if (status === "correct") dot.classList.add("dot-green");
            else if (status === "wrong") dot.classList.add("dot-red");
            else if (status === "not_attempted") dot.classList.add("dot-yellow");
            else dot.classList.add("dot-gray");

            dot.addEventListener("click", () => {
                const states = ["correct", "wrong", "not_attempted", "no_data"];
                let idx = states.indexOf(q.attempts[j] || "no_data");
                idx = (idx + 1) % states.length;
                q.attempts[j] = states[idx] === "no_data" ? undefined : states[idx];
                saveData();
                loadChapterTable();
            });

            const td = document.createElement("td");
            td.appendChild(dot);
            row.appendChild(td);
        }

        tableBody.appendChild(row);
    }
}

// Event Listeners
document.getElementById("loadChapter").addEventListener("click", () => {
    currentBook = document.getElementById("bookSelect").value;
    currentChapter = document.getElementById("chapterSelect").value;

    if (!data.books[currentBook]) data.books[currentBook] = {};
    if (!data.books[currentBook][currentChapter]) {
        const totalQ = parseInt(prompt("Enter total questions for this chapter:"));
        data.books[currentBook][currentChapter] = { total_questions: totalQ, questions: {} };
        saveData();
    }
    loadChapterTable();
});

document.getElementById("markAllCorrect").addEventListener("click", () => {
    const chapterData = data.books[currentBook][currentChapter];
    Object.values(chapterData.questions).forEach(q => q.attempts[0] = "correct");
    saveData();
    loadChapterTable();
});
document.getElementById("markAllWrong").addEventListener("click", () => {
    const chapterData = data.books[currentBook][currentChapter];
    Object.values(chapterData.questions).forEach(q => q.attempts[0] = "wrong");
    saveData();
    loadChapterTable();
});
document.getElementById("markAllNA").addEventListener("click", () => {
    const chapterData = data.books[currentBook][currentChapter];
    Object.values(chapterData.questions).forEach(q => q.attempts[0] = "not_attempted");
    saveData();
    loadChapterTable();
});
document.getElementById("newAttempt").addEventListener("click", () => {
    const chapterData = data.books[currentBook][currentChapter];
    Object.values(chapterData.questions).forEach(q => {
        q.attempts.unshift(undefined);
        if (q.attempts.length > 7) q.attempts.pop();
    });
    saveData();
    loadChapterTable();
});

// Init
loadData();
</script>

</body>
</html>
